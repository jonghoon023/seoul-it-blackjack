# Seoul.It.Blackjack 블랙잭 규칙

이 문서는 이 프로젝트에서 사용하는 **게임 규칙 자체**를 정의합니다.
코드 구조 설명은 `docs/Seoul.It.Blackjack.rules-code-overview.md`에서 다룹니다.

## 1. 기본 구조

1. 게임은 단일 방으로 운영한다.
2. 게임 상태는 `Idle`(대기), `InRound`(라운드 진행) 두 단계만 사용한다.
3. 딜러는 플레이어 중 `IsDealer=true`인 단 한 명이다.

## 2. 카드/점수

1. 무늬: `Clubs`, `Diamonds`, `Hearts`, `Spades`
2. 숫자: `Two`~`Ten`, `Jack`, `Queen`, `King`, `Ace`
3. 점수:
- `Ace = 1`
- `Two..Nine = 숫자 그대로`
- `Ten/Jack/Queen/King = 10`
4. Ace의 1/11 가변 규칙은 사용하지 않는다.

## 3. 입장(Join) 규칙

1. 라운드 진행 중(`InRound`)에는 신규 입장 불가.
2. 같은 연결의 재입장 불가.
3. 이름 규칙:
- 양쪽 공백 제거(`Trim`) 후 길이 `1~20`
- 빈 문자열/공백만 입력 불가
- 중복 이름은 허용
4. 딜러 판정:
- `dealerKey`가 서버의 `DealerOptions.Key`와 같으면 딜러
- 다르면 일반 플레이어
5. 딜러는 1명만 허용.

## 4. 라운드 시작(StartRound) 규칙

1. 요청자는 반드시 입장 상태여야 한다.
2. 상태가 `Idle`일 때만 시작 가능.
3. 시작 요청은 딜러만 가능.
4. 최소 인원(기본 2명) 미만이면 시작 불가.
5. 시작 시:
- Shoe를 새로 생성
- 모든 플레이어의 카드/점수/결과 초기화
- 플레이어마다 카드 2장 배분

## 5. 턴과 행동 규칙

`Hit`, `Stand`는 아래 조건을 모두 만족해야 한다.

1. 요청자가 입장 상태
2. 게임 상태가 `InRound`
3. 요청자가 딜러가 아님
4. 요청자가 현재 턴 플레이어
5. 요청자의 턴 상태가 `Playing`

### Hit

1. 카드 1장을 더 받는다.
2. 점수 재계산:
- 21 초과: `Busted`
- 21 도달: `Standing`
- 21 미만: `Playing` 유지
3. 행동 후 조건에 따라 턴 유지/다음 턴 이동.

### Stand

1. 턴 상태를 `Standing`으로 변경.
2. 다음 플레이어 턴으로 이동.

## 6. 딜러 자동 진행 규칙

1. 일반 플레이어가 모두 행동을 끝내면 딜러가 자동으로 진행한다.
2. 딜러 점수가 `17` 미만이면 자동 Hit 반복.
3. `17` 이상이면 자동 Stand.
4. 딜러는 수동 Hit/Stand를 할 수 없다.

## 7. 결과 계산 규칙

일반 플레이어별로 딜러와 비교한다.

1. 플레이어가 Bust면 `Lose`.
2. 딜러가 Bust고 플레이어가 Bust가 아니면 `Win`.
3. 둘 다 Bust가 아니면 점수 비교:
- 플레이어 > 딜러: `Win`
- 플레이어 < 딜러: `Lose`
- 플레이어 == 딜러: `Tie`

## 8. 라운드 종료 후

1. 라운드 종료 시 상태는 `Idle`.
2. 현재 턴 ID는 비움.
3. 직전 결과는 Idle 상태에서 유지.
4. 다음 라운드 시작 시 다시 초기화.

## 9. 퇴장/종료 규칙

### 일반 플레이어 퇴장

1. 해당 플레이어만 제거.
2. 현재 턴 플레이어가 나가면 턴 재계산.
3. 진행 중 일반 플레이어가 없어지면 라운드 종료.

### 딜러 퇴장

1. 게임 전체 종료.
2. 모든 플레이어/매핑 초기화.
3. 전체 클라이언트에 종료 알림 전송.
4. 초기화 상태를 전체 브로드캐스트.

## 10. 카드 소진(Shoe Empty)

1. 카드가 부족하면 라운드를 즉시 종료.
2. 상태를 `Idle`로 전환.
3. 전체에 카드 소진 알림과 상태를 전송.

## 11. 브로드캐스트 정책

1. 정상 상태 변경: 전체(`All`)에게 상태 전송.
2. 요청자 오류: 요청자(`Caller`)에게만 오류 전송.
3. 전역 공지(게임 종료/카드 소진 등): 전체(`All`)에게 오류 코드/메시지 전송.

## 12. 고정 에러 코드

1. `GAME_IN_PROGRESS`
2. `NOT_JOINED`
3. `NOT_DEALER`
4. `DEALER_IS_AUTO`
5. `DEALER_ALREADY_EXISTS`
6. `INVALID_NAME`
7. `ALREADY_JOINED`
8. `GAME_TERMINATED`
9. `NOT_YOUR_TURN`
10. `GAME_NOT_INROUND`
11. `ALREADY_DONE`
12. `INSUFFICIENT_PLAYERS`
13. `SHOE_EMPTY`

## 13. 제외된 기능(교육용 단순화)

1. 멀티룸
2. Ace 1/11 가변 계산
3. 스플릿
4. 더블다운
5. 보험
6. 딜러 수동 플레이

